<head>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        body { margin: 0; }
        #main{
            z-index:1000;
            position:fixed;
            bottom:1vh;
            left:50%;
            transform: translateX(-50%);
        }
        #nodes{
            z-index:1000;
            position:fixed;
            bottom: 1vh;
            left: 1vw;
            color: white;
        }
        #level{
            z-index:1000;
            position:fixed;
            bottom:1vh;
            right: 1vw;
            color: white;
        }
    </style>
</head>

<body>
    <div id="3d-graph"></div>
    <span id="nodes">nodes now: <span id="nd-num">1</span></span>
    <button id="main" onclick="addEvt()">ADD NODE</button>
    <span id="level">level: <span id="lv-num">0</span></span>
    <script>
        const initData = {
            nodes: [ {id: 0 } ],
            links: []
        };
        let clicks = 0;
        const colors = [
            ["white","grey"],
            ["red","green","blue"],
            ["yellow","cyan","fuchsia"],
            ["#404040","#C0C0C0"],
            ["#80ff00","#00ff80","#ff0080","#ff8000","#0080ff","#8000ff"],
            ["#80ffff","#ff80ff","#ffff80"],
            ["#8080ff","#80ff80","#ff8080"]
        ];
        let curColors = [];
        const levels = ["10","50","100","250","1000","2000","5000","10000"];
        const elem = document.getElementById("3d-graph");
        
        const Graph = ForceGraph3D()(elem)
                .enableNodeDrag(false)
                .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
                .graphData(initData)
                .onNodeClick(removeNode)
                .backgroundColor("#000000");
        function addNode(){
        const { nodes, links } = Graph.graphData();
            const id = nodes.length;
            Graph.graphData({
                nodes: [...nodes, { id:id , color: curColors[Math.floor(Math.random() * curColors.length)]}],
                links: [...links, { source: id, target: Math.round(Math.random() * (id-1)) , color: "black"}]
            });
        }
        let level = 0;
        function changeLev(){
            if(clicks == 1){
                curColors.push(...colors[0]);
            }else if(clicks == 50){
                curColors.push(...colors[1]);
                level = 1;
            }else if(clicks == 100){
                curColors.push(...colors[2]);
                level = 2;
            }else if(clicks == 250){
                curColors.push(...colors[3]);
                level = 3;
            }else if(clicks == 1000){
                curColors.push(...colors[4]);
                level = 4;
            }else if(clicks == 2000){
                curColors.push(...colors[5]);
                level = 6;
            }else if(clicks == 5000){
                curColors.push(...colors[6]);
                level = 7;
            }else if(clicks == 1000){
                if(! fullColor){
                    let allColors = [];
                    for (var r=0; r<=0xFF0000; r+=0x330000){
                        for (var g=0; g<=0xFF00; g+=0x3300){
                            for (var b=0; b<=0xFF; b+=0x33){
                                allColors.push("#"+ (r|g|b).toString(16).padStart(6, "0") );
                            }
                        }
                    }
                    curColors = allColors;
                    fullColor = 1;
                }
                level = 8;
            }else{}
        }

        function addEvt(){
        document.getElementById('nd-num').textContent++;
        document.getElementById('lv-num').textContent = level;
        clicks++
        changeLev();
        addNode();
        }

        function removeNode(node) {
            let { nodes, links } = Graph.graphData();
            links = links.filter(l => l.source !== node && l.target !== node); // Remove links attached to node
            nodes.splice(node.id, 1); // Remove node
            nodes.forEach((n, idx) => { n.id = idx; }); // Reset node ids to array index
            Graph.graphData({ nodes, links });
            document.getElementById('nd-num').textContent--;
        }
    </script>
    <script type="module">
    import { UnrealBloomPass } from 'https://esm.sh/three/examples/jsm/postprocessing/UnrealBloomPass.js';

    const bloomPass = new UnrealBloomPass();
    bloomPass.strength = 6;
    bloomPass.radius = 1;
    bloomPass.threshold = 0;
    Graph.postProcessingComposer().addPass(bloomPass);
  </script>
</body>
